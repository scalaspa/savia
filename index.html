<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a192f">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <title>Savia Ultra</title>
    <style>
        :root { --navy: #0a192f; --gold: #c5a059; --bg: #f4f7f6; --white: #fff; --text: #2c3e50; --danger: #e74c3c; --success: #27ae60; --warning: #f39c12; }
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        /* UI COMPONENTS */
        .topbar { background: var(--white); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 20; height: 60px; }
        .menu-btn { font-size: 24px; color: var(--navy); cursor: pointer; }
        .app-title { font-weight: 900; color: var(--navy); font-size: 20px; letter-spacing: -0.5px; }
        .add-btn { background: var(--navy); color: var(--gold); border: none; width: 38px; height: 38px; border-radius: 50%; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(10, 25, 47, 0.3); }

        .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 280px; background: var(--navy); transform: translateX(-100%); transition: 0.3s; z-index: 100; padding: 20px; display:flex; flex-direction:column; box-shadow: 4px 0 20px rgba(0,0,0,0.2); }
        .sidebar.active { transform: translateX(0); }
        .nav-item { padding: 15px; color: #a8b2d1; font-weight: 500; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .nav-item.active { color: var(--gold); background: rgba(197, 160, 89, 0.1); border-left: 4px solid var(--gold); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; display: none; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }

        .main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        .card { background: var(--white); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02); }
        
        /* ACCOUNTS SCROLL */
        .acc-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px; scroll-behavior: smooth; }
        .acc-card { min-width: 140px; background: var(--navy); color: white; padding: 15px; border-radius: 12px; flex-shrink: 0; position: relative; overflow: hidden; }
        .acc-card.credit { background: #34495e; }
        .acc-name { font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
        .acc-bal { font-size: 16px; font-weight: bold; margin-top: 5px; color: var(--gold); }
        
        /* BUDGET BARS */
        .prog-container { background: #eee; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .prog-bar { height: 100%; background: var(--success); transition: 0.5s; }
        .prog-bar.warn { background: var(--warning); }
        .prog-bar.danger { background: var(--danger); }
        .budget-row { margin-bottom: 15px; }
        .budget-info { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 2px; }

        /* INSIGHTS */
        .insight-tag { display: inline-block; padding: 4px 8px; background: #e8f6f3; color: #16a085; border-radius: 6px; font-size: 11px; font-weight: bold; margin-right: 5px; }
        .trend-up { color: var(--danger); } .trend-down { color: var(--success); }

        /* FORMS & MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-box { background: #fff; width: 92%; max-width: 420px; padding: 25px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 12px; font-weight: bold; color: #666; margin-bottom: 5px; display: block; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: #f9f9f9; transition: 0.2s; }
        .form-control:focus { border-color: var(--navy); background: #fff; }
        .btn { padding: 14px; border-radius: 10px; border: none; font-weight: bold; width: 100%; cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--navy); color: white; }
        .btn-gold { background: var(--gold); color: var(--navy); }
        .btn-danger { background: #fee; color: var(--danger); }
        
        /* TABLE & LISTS */
        .tx-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .tx-left { display: flex; gap: 10px; align-items: center; }
        .tx-cat-icon { width: 35px; height: 35px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .tx-amount { font-weight: bold; font-size: 15px; }
        .tag-badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 10px; color: #666; margin-left: 5px; }
    </style>
</head>
<body>

    <div class="overlay" onclick="UI.toggleMenu()"></div>
    
    <nav class="sidebar" id="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
            <div class="app-title" style="color:var(--gold)">Savia Ultra</div>
            <div onclick="UI.toggleMenu()" style="color:white; font-size:20px; cursor:pointer">‚úï</div>
        </div>
        <div class="nav-item active" onclick="UI.nav('dashboard')">üìä Dashboard</div>
        <div class="nav-item" onclick="UI.nav('budgets')">‚öñÔ∏è Presupuestos</div>
        <div class="nav-item" onclick="UI.nav('accounts')">üí≥ Cuentas</div>
        <div class="nav-item" onclick="UI.nav('transactions')">üìù Movimientos</div>
        <div class="nav-item" onclick="UI.nav('autopilot')">üìÖ Autopilot</div>
        <div class="nav-item" onclick="UI.nav('tools')">üõ†Ô∏è Herramientas</div>
        <div style="margin-top:auto; font-size:11px; text-align:center; color:rgba(255,255,255,0.3)">Versi√≥n 5.0 Ultra</div>
    </nav>

    <header class="topbar">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="menu-btn" onclick="UI.toggleMenu()">‚ò∞</div>
            <div class="app-title">Savia</div>
        </div>
        <button class="add-btn" onclick="UI.openModal()">+</button>
    </header>

    <main class="main" id="main-container">
        </main>

    <div id="modal-tx" class="modal">
        <div class="modal-box">
            <h3 id="modal-title" style="margin-top:0; color:var(--navy)">Nuevo Movimiento</h3>
            
            <div class="form-group">
                <div style="display:flex; gap:5px; margin-bottom:10px">
                    <button class="btn btn-primary" onclick="UI.setTxType('Gasto')" id="btn-type-gasto" style="flex:1; opacity:0.5">Gasto</button>
                    <button class="btn btn-primary" onclick="UI.setTxType('Ingreso')" id="btn-type-ingreso" style="flex:1; opacity:0.5">Ingreso</button>
                    <button class="btn btn-primary" onclick="UI.setTxType('Transferencia')" id="btn-type-transf" style="flex:1; opacity:0.5">Transf.</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Monto</label>
                <input type="number" id="inp-amt" class="form-control" placeholder="$0" style="font-size:24px; font-weight:bold; color:var(--navy)">
            </div>

            <div class="form-group" id="group-cat">
                <label class="form-label">Categor√≠a</label>
                <div style="display:flex; gap:5px">
                    <select id="inp-cat" class="form-control"></select>
                    <button onclick="APP.addCat()" style="width:45px; border:1px solid #ddd; background:#eee; border-radius:8px">+</button>
                </div>
            </div>

            <div class="form-group" id="group-acc-source">
                <label class="form-label">Cuenta (Origen)</label>
                <select id="inp-acc" class="form-control"></select>
            </div>
            
            <div class="form-group" id="group-acc-dest" style="display:none">
                <label class="form-label">A Cuenta (Destino)</label>
                <select id="inp-acc-dest" class="form-control"></select>
            </div>

            <div class="form-group">
                <div style="display:flex; gap:10px">
                    <div style="flex:1">
                        <label class="form-label">Fecha</label>
                        <input type="date" id="inp-date" class="form-control">
                    </div>
                    <div style="flex:1">
                        <label class="form-label">Etiqueta (Tag)</label>
                        <input type="text" id="inp-tag" class="form-control" placeholder="#Viaje">
                    </div>
                </div>
            </div>

            <input type="text" id="inp-note" class="form-control" placeholder="Nota (Opcional)" style="margin-bottom:20px">
            
            <div style="display:flex; gap:10px">
                <button class="btn btn-primary" onclick="APP.saveTx()">Guardar</button>
                <button class="btn" style="background:#eee; color:#333" onclick="UI.closeModal()">Cancelar</button>
            </div>
        </div>
    </div>

<script>
    /** SAVIA ENGINE V5.0 **/
    const UTILS = {
        fmt: (n) => "$" + parseInt(n).toLocaleString('es-CL'),
        id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
        date: () => new Date().toISOString().split('T')[0]
    };

    const DB = {
        data: { tx: [], acc: [], budgets: {}, goals: [], fix: [], cats: {} },
        
        init: function() {
            const raw = localStorage.getItem('savia_db_v5');
            if(raw) {
                this.data = JSON.parse(raw);
            } else {
                this.migrateFromV4();
            }
            if(!this.data.acc.length) this.data.acc = [{id:'acc_def', name:'Efectivo', type:'Efectivo', bal:0}];
            if(!this.data.cats.Personal) this.data.cats = { 
                Personal: { Gasto: ['Alimentaci√≥n','Transporte','Hogar','Salud','Ocio'], Ingreso: ['Sueldo','Extra'] } 
            };
        },
        save: function() { localStorage.setItem('savia_db_v5', JSON.stringify(this.data)); },
        migrateFromV4: function() {
            // Migraci√≥n autom√°tica de versiones anteriores
            const oldTx = JSON.parse(localStorage.getItem('scala_uc_tx') || '[]');
            const oldFix = JSON.parse(localStorage.getItem('scala_uc_fix') || '[]');
            this.data.acc = [{id:'def', name:'Cuenta Principal', type:'Efectivo', bal:0}];
            this.data.tx = oldTx.map(t => ({...t, accId: 'def', tags: []}));
            this.data.fix = oldFix;
            this.save();
            alert("‚úÖ Savia ha migrado tus datos a la versi√≥n Ultra.");
        }
    };

    const APP = {
        currTxType: 'Gasto',
        editId: null,

        run: function() {
            DB.init();
            UI.nav('dashboard');
        },

        // LOGICA DE NEGOCIO
        getBalance: (accId) => {
            // Calculo din√°mico de saldo
            const acc = DB.data.acc.find(a => a.id === accId);
            if(!acc) return 0;
            let bal = parseFloat(acc.bal || 0); // Saldo inicial
            DB.data.tx.forEach(t => {
                if(t.accId === accId) {
                    if(t.type === 'Ingreso') bal += t.amt;
                    if(t.type === 'Gasto') bal -= t.amt;
                    if(t.type === 'Transferencia') bal -= t.amt;
                }
                if(t.destId === accId && t.type === 'Transferencia') bal += t.amt;
            });
            return bal;
        },

        getBudgetStatus: (cat) => {
            const limit = DB.data.budgets[cat] || 0;
            if(limit === 0) return null;
            
            const month = UTILS.date().slice(0,7);
            const spent = DB.data.tx
                .filter(t => t.cat === cat && t.type === 'Gasto' && t.date.startsWith(month))
                .reduce((s, t) => s + t.amt, 0);
            
            return { limit, spent, pct: (spent/limit)*100, remain: limit - spent };
        },

        addCat: function() {
            const n = prompt("Nueva Categor√≠a:");
            if(n) { DB.data.cats.Personal[APP.currTxType].push(n); DB.save(); UI.renderCatOpts(); }
        },

        saveTx: function() {
            const amt = parseFloat(document.getElementById('inp-amt').value);
            const desc = document.getElementById('inp-note').value;
            const date = document.getElementById('inp-date').value;
            const cat = document.getElementById('inp-cat').value;
            const accId = document.getElementById('inp-acc').value;
            const tag = document.getElementById('inp-tag').value;
            
            if(!amt || !date) return alert("Falta monto o fecha");

            const txObj = {
                id: APP.editId || UTILS.id(),
                type: APP.currTxType,
                amt, date, cat, note: desc, accId, tags: tag ? [tag] : []
            };

            if(APP.currTxType === 'Transferencia') {
                txObj.destId = document.getElementById('inp-acc-dest').value;
                txObj.cat = 'Transferencia';
                if(txObj.accId === txObj.destId) return alert("Origen y destino iguales");
            }

            if(APP.editId) {
                const idx = DB.data.tx.findIndex(t => t.id === APP.editId);
                DB.data.tx[idx] = txObj;
            } else {
                DB.data.tx.push(txObj);
            }

            DB.save();
            UI.closeModal();
            UI.refreshCurrent();
        },
        
        delTx: (id) => { if(confirm("¬øBorrar?")) { DB.data.tx = DB.data.tx.filter(t=>t.id!==id); DB.save(); UI.refreshCurrent(); } },
        
        // GESTION CUENTAS
        addAccount: function() {
            const n = prompt("Nombre Cuenta (ej: Banco Falabella):");
            const t = prompt("Tipo (D√©bito, Cr√©dito, Efectivo):");
            const b = prompt("Saldo Inicial Actual:", "0");
            if(n) { 
                DB.data.acc.push({id: UTILS.id(), name: n, type: t || 'Banco', bal: parseFloat(b)});
                DB.save(); UI.nav('accounts');
            }
        },
        
        // GESTION PRESUPUESTOS
        setBudget: function(cat) {
            const curr = DB.data.budgets[cat] || 0;
            const lim = prompt(`L√≠mite mensual para ${cat}:`, curr);
            if(lim !== null) {
                DB.data.budgets[cat] = parseFloat(lim);
                DB.save(); UI.nav('budgets');
            }
        }
    };

    const UI = {
        currView: 'dashboard',
        
        toggleMenu: () => {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        },

        nav: (view) => {
            UI.currView = view;
            UI.toggleMenu(); // Cierra men√∫ si est√° abierto
            const main = document.getElementById('main-container');
            main.innerHTML = ''; 
            
            // ROUTER SIMPLE
            if(view === 'dashboard') UI.renderDashboard(main);
            if(view === 'transactions') UI.renderTransactions(main);
            if(view === 'accounts') UI.renderAccounts(main);
            if(view === 'budgets') UI.renderBudgets(main);
            if(view === 'tools') UI.renderTools(main);
            if(view === 'autopilot') UI.renderAutopilot(main);
        },

        refreshCurrent: () => UI.nav(UI.currView),

        // --- VISTAS ---

        renderDashboard: (el) => {
            // 1. Cuentas Scroll
            let accHtml = '';
            DB.data.acc.forEach(a => {
                const realBal = APP.getBalance(a.id);
                accHtml += `<div class="acc-card ${a.type==='Cr√©dito'?'credit':''}">
                    <div class="acc-name">${a.name}</div>
                    <div class="acc-bal">${UTILS.fmt(realBal)}</div>
                    <div style="font-size:10px; margin-top:5px; opacity:0.7">${a.type}</div>
                </div>`;
            });
            
            // 2. Insights
            const month = UTILS.date().slice(0,7);
            const monthTx = DB.data.tx.filter(t => t.date.startsWith(month) && t.type==='Gasto');
            const totalExp = monthTx.reduce((s,t)=>s+t.amt,0);
            
            // Top Cat
            const catMap = {}; monthTx.forEach(t=> catMap[t.cat] = (catMap[t.cat]||0)+t.amt);
            const topCat = Object.keys(catMap).sort((a,b)=>catMap[b]-catMap[a])[0] || 'N/A';
            
            // HTML Structure
            el.innerHTML = `
                <div class="acc-scroll">${accHtml} <div class="acc-card" onclick="APP.addAccount()" style="background:#eee; color:#333; display:flex; align-items:center; justify-content:center; font-size:24px">+</div></div>
                
                <div class="card">
                    <h3>üì¢ Insights del Mes</h3>
                    <div style="margin-bottom:10px">
                        <span class="insight-tag">üèÜ Top Gasto: ${topCat}</span>
                        <span class="insight-tag">üìâ Total: ${UTILS.fmt(totalExp)}</span>
                    </div>
                    <p style="font-size:13px; color:#666">
                        ${totalExp > 500000 ? '‚ö†Ô∏è El gasto est√° alto este mes.' : '‚úÖ Vas bien con tus gastos.'}
                    </p>
                </div>

                <div class="card">
                    <h3>üöß Alertas de Presupuesto</h3>
                    <div id="dash-budgets"></div>
                </div>
            `;
            
            // Render Mini Budgets
            const budEl = document.getElementById('dash-budgets');
            let hasBud = false;
            Object.keys(DB.data.budgets).forEach(cat => {
                const st = APP.getBudgetStatus(cat);
                if(st && st.limit > 0) {
                    hasBud = true;
                    let color = ''; 
                    if(st.pct > 100) color = 'danger';
                    else if(st.pct > 80) color = 'warn';
                    
                    budEl.innerHTML += `
                        <div class="budget-row">
                            <div class="budget-info">
                                <b>${cat}</b>
                                <span>${UTILS.fmt(st.spent)} / ${UTILS.fmt(st.limit)}</span>
                            </div>
                            <div class="prog-container">
                                <div class="prog-bar ${color}" style="width:${Math.min(st.pct, 100)}%"></div>
                            </div>
                            ${st.remain < 0 ? `<small style="color:red">Excedido en ${UTILS.fmt(Math.abs(st.remain))}</small>` : ''}
                        </div>
                    `;
                }
            });
            if(!hasBud) budEl.innerHTML = '<small>No has configurado presupuestos a√∫n.</small>';
        },

        renderTransactions: (el) => {
            // Filtros b√°sicos
            el.innerHTML = `
                <div class="card">
                    <input type="text" id="search-tx" class="form-control" placeholder="üîç Buscar por nota, tag o categor√≠a..." onkeyup="UI.renderTxList(this.value)">
                </div>
                <div class="card" id="tx-list"></div>
            `;
            UI.renderTxList();
        },

        renderTxList: (filter = '') => {
            const listEl = document.getElementById('tx-list');
            listEl.innerHTML = '';
            
            let data = DB.data.tx.sort((a,b) => new Date(b.date) - new Date(a.date));
            if(filter) {
                const f = filter.toLowerCase();
                data = data.filter(t => (t.note+t.cat+t.tags.join('')).toLowerCase().includes(f));
            }

            data.slice(0, 50).forEach(t => {
                const accName = DB.data.acc.find(a=>a.id===t.accId)?.name || '???';
                let icon = 'üí∏'; 
                if(t.type==='Ingreso') icon = 'üí∞';
                if(t.type==='Transferencia') icon = 'üîÑ';

                listEl.innerHTML += `
                    <div class="tx-row" onclick="UI.editTx('${t.id}')">
                        <div class="tx-left">
                            <div class="tx-cat-icon">${icon}</div>
                            <div>
                                <div style="font-weight:bold">${t.cat} ${t.tags.map(tag=>`<span class="tag-badge">${tag}</span>`).join('')}</div>
                                <div style="font-size:12px; color:#888">${t.date} ‚Ä¢ ${accName}</div>
                                ${t.note ? `<div style="font-size:11px; color:#666; font-style:italic">${t.note}</div>` : ''}
                            </div>
                        </div>
                        <div class="tx-amount" style="color:${t.type==='Ingreso'?'var(--success)':'var(--text)'}">
                            ${t.type==='Gasto'?'-':''} ${UTILS.fmt(t.amt)}
                        </div>
                    </div>
                `;
            });
        },

        renderBudgets: (el) => {
            let html = '<div class="card"><h3>Definir L√≠mites Mensuales</h3>';
            const allCats = DB.data.cats.Personal.Gasto; // Solo gastos
            
            allCats.forEach(cat => {
                const st = APP.getBudgetStatus(cat);
                const limit = DB.data.budgets[cat] || 0;
                html += `
                    <div class="tx-row" onclick="APP.setBudget('${cat}')">
                        <div><b>${cat}</b><br><small>${limit > 0 ? 'Meta: '+UTILS.fmt(limit) : 'Sin l√≠mite'}</small></div>
                        <div style="text-align:right">
                            ${st ? UTILS.fmt(st.spent) : '$0'}
                            <div style="font-size:20px; color:var(--navy)">‚úé</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            el.innerHTML = html;
        },
        
        renderAccounts: (el) => {
            el.innerHTML = `<button class="btn btn-primary" style="margin-bottom:15px" onclick="APP.addAccount()">+ Nueva Cuenta</button>`;
            DB.data.acc.forEach(a => {
                el.innerHTML += `
                    <div class="card" style="display:flex; justify-content:space-between">
                        <div>
                            <h3>${a.name}</h3>
                            <div style="color:#666">${a.type}</div>
                        </div>
                        <div style="text-align:right">
                            <h2 style="color:var(--gold); margin:0">${UTILS.fmt(APP.getBalance(a.id))}</h2>
                            <small>Saldo Actual</small>
                        </div>
                    </div>
                `;
            });
        },

        renderTools: (el) => {
            el.innerHTML = `
                <div class="card">
                    <h3>üì• Importar / Exportar</h3>
                    <button class="btn btn-gold" onclick="TOOLS.exportJSON()">Hacer Backup (JSON)</button>
                    <br>
                    <button class="btn btn-outline" onclick="document.getElementById('file-import').click()">Restaurar Backup</button>
                    <input type="file" id="file-import" style="display:none" onchange="TOOLS.importJSON(this)">
                </div>
                <div class="card">
                    <h3>üìÑ Importar CSV (Banco)</h3>
                    <p style="font-size:12px">Sube un CSV simple (Fecha, Descripci√≥n, Monto) para cargar masivamente.</p>
                    <input type="file" id="csv-import" class="form-control" onchange="TOOLS.importCSV(this)">
                </div>
            `;
        },

        renderAutopilot: (el) => {
             el.innerHTML = `
                <div class="card">
                    <h3>Cuentas Fijas (Autopilot)</h3>
                    <p style="font-size:12px">Agrega gastos recurrentes para no olvidarlos.</p>
                    <button class="btn btn-primary" onclick="APP.addFix()">+ Nueva Cuenta Fija</button>
                    <div id="fix-list" style="margin-top:15px"></div>
                </div>
            `;
            const list = document.getElementById('fix-list');
            const month = UTILS.date().slice(0,7);
            
            DB.data.fix.forEach(f => {
                // Chequear si se pag√≥ este mes
                const isPaid = DB.data.tx.some(t => t.cat === f.name && t.date.startsWith(month));
                list.innerHTML += `
                    <div class="tx-row">
                        <div>
                            <b>${f.name}</b> (D√≠a ${f.day})
                            <br><small>${UTILS.fmt(f.cost)}</small>
                        </div>
                        <div>
                            ${isPaid 
                                ? '<span style="color:green; font-weight:bold">‚úÖ Pagado</span>' 
                                : `<button class="btn-gold" style="padding:5px 10px; font-size:12px" onclick="APP.quickPay('${f.name}', ${f.cost})">Pagar</button>`
                            }
                        </div>
                    </div>
                `;
            });
        },

        // --- MODALES & FORMS ---
        openModal: () => {
            APP.editId = null;
            document.getElementById('modal-title').innerText = "Nuevo Movimiento";
            document.getElementById('inp-amt').value = '';
            document.getElementById('inp-note').value = '';
            document.getElementById('inp-tag').value = '';
            document.getElementById('inp-date').value = UTILS.date();
            UI.renderAccOpts();
            UI.setTxType('Gasto');
            document.getElementById('modal-tx').style.display = 'flex';
        },
        
        closeModal: () => document.getElementById('modal-tx').style.display = 'none',

        editTx: (id) => {
            const t = DB.data.tx.find(x=>x.id===id);
            if(!t) return;
            UI.openModal();
            APP.editId = id;
            document.getElementById('modal-title').innerText = "Editar Movimiento";
            UI.setTxType(t.type);
            document.getElementById('inp-amt').value = t.amt;
            document.getElementById('inp-date').value = t.date;
            document.getElementById('inp-cat').value = t.cat;
            document.getElementById('inp-acc').value = t.accId;
            document.getElementById('inp-note').value = t.note;
            document.getElementById('inp-tag').value = t.tags ? t.tags.join(' ') : '';
        },

        setTxType: (type) => {
            APP.currTxType = type;
            ['gasto','ingreso','transf'].forEach(t => document.getElementById('btn-type-'+t).style.opacity = '0.5');
            
            if(type==='Gasto') document.getElementById('btn-type-gasto').style.opacity = '1';
            if(type==='Ingreso') document.getElementById('btn-type-ingreso').style.opacity = '1';
            if(type==='Transferencia') document.getElementById('btn-type-transf').style.opacity = '1';

            if(type === 'Transferencia') {
                document.getElementById('group-cat').style.display = 'none';
                document.getElementById('group-acc-dest').style.display = 'block';
            } else {
                document.getElementById('group-cat').style.display = 'block';
                document.getElementById('group-acc-dest').style.display = 'none';
                UI.renderCatOpts();
            }
        },

        renderCatOpts: () => {
            const sel = document.getElementById('inp-cat');
            sel.innerHTML = '';
            const list = DB.data.cats.Personal[APP.currTxType] || [];
            list.forEach(c => sel.innerHTML += `<option>${c}</option>`);
        },

        renderAccOpts: () => {
            const fill = (id) => {
                const el = document.getElementById(id);
                el.innerHTML = '';
                DB.data.acc.forEach(a => el.innerHTML += `<option value="${a.id}">${a.name} ($${a.bal})</option>`);
            };
            fill('inp-acc');
            fill('inp-acc-dest');
        }
    };

    APP.addFix = function() {
        const n = prompt("Nombre Gasto Fijo:");
        const c = prompt("Monto Estimado:");
        const d = prompt("D√≠a de Pago (1-31):");
        if(n && c) { DB.data.fix.push({id:UTILS.id(), name:n, cost:c, day:d}); DB.save(); UI.refreshCurrent(); }
    };

    APP.quickPay = function(name, cost) {
        APP.currTxType = 'Gasto';
        APP.editId = null;
        // Pre-llenar modal
        UI.openModal();
        // Esperar render
        setTimeout(() => {
             // Crear categoria si no existe
             if(!DB.data.cats.Personal.Gasto.includes(name)) {
                 DB.data.cats.Personal.Gasto.push(name);
                 UI.renderCatOpts();
             }
             document.getElementById('inp-cat').value = name;
             document.getElementById('inp-amt').value = cost;
             document.getElementById('inp-note').value = 'Pago Recurrente';
        }, 100);
    };

    const TOOLS = {
        exportJSON: () => {
            const str = JSON.stringify(DB.data);
            const blob = new Blob([str], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `savia_backup_${UTILS.date()}.json`;
            a.click();
        },
        importJSON: (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if(confirm("Esto reemplazar√° todos tus datos actuales. ¬øSeguro?")) {
                    DB.data = JSON.parse(e.target.result);
                    DB.save();
                    location.reload();
                }
            };
            reader.readAsText(file);
        },
        importCSV: (input) => {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split('\n');
                let count = 0;
                // Parser simple: Asume columnas Fecha, Descripcion, Monto (ajustar segun banco)
                // Se asume que el usuario revisa despues.
                lines.slice(1).forEach(line => {
                    const col = line.split(',');
                    if(col.length >= 3) {
                        const amt = parseFloat(col[2]);
                        if(!isNaN(amt)) {
                            DB.data.tx.push({
                                id: UTILS.id(),
                                date: col[0].trim() || UTILS.date(), // Intentar leer fecha o usar hoy
                                note: col[1].replace(/"/g, ''),
                                amt: Math.abs(amt),
                                type: amt < 0 ? 'Gasto' : 'Ingreso',
                                cat: 'Sin Categor√≠a',
                                accId: DB.data.acc[0].id, // A la primera cuenta
                                tags: ['#importado']
                            });
                            count++;
                        }
                    }
                });
                DB.save();
                alert(`Se importaron ${count} movimientos. Revisa en "Movimientos" para categorizar.`);
                UI.refreshCurrent();
            };
            reader.readAsText(file);
        }
    };

    // INICIO
    window.onload = APP.run;

</script>
</body>
</html>
