<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a192f">
    
    <link rel="icon" type="image/jpeg" href="icon.jpeg">
    <link rel="apple-touch-icon" href="icon.jpeg">
    
    <title>SavIA by ScalaSpA</title>
    
    <style>
        :root { --navy: #0a192f; --gold: #c5a059; --bg: #f0f2f5; --white: #fff; --text: #2c3e50; --danger: #e74c3c; --success: #27ae60; --warning: #f1c40f; --info: #3498db; }
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        /* --- LOCK SCREEN (PIN) --- */
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--navy); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: 0.3s; }
        .lock-logo { width: 80px; height: 80px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; border: 2px solid var(--gold); }
        .pin-dots { display: flex; gap: 15px; margin-bottom: 40px; }
        .pin-dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid var(--gold); transition: 0.2s; }
        .pin-dot.filled { background: var(--gold); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 300px; }
        .num-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s; }
        .num-btn:active { background: var(--gold); color: var(--navy); }
        
        /* SHAKE ANIMATION (iPhone Style) */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }
        .shake { animation: shake 0.3s ease-in-out; }
        
        /* LAYOUT */
        .topbar { background: var(--white); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); z-index: 20; height: 65px; }
        .menu-btn { font-size: 24px; color: var(--navy); cursor: pointer; }
        .app-title { font-weight: 900; color: var(--navy); font-size: 20px; letter-spacing: -0.5px; }
        
        .add-btn { background: var(--navy); color: var(--gold); border: none; padding: 0 18px; height: 38px; border-radius: 19px; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(10, 25, 47, 0.25); transition: transform 0.2s; }
        .add-btn:active { transform: scale(0.95); }

        .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 280px; background: var(--navy); transform: translateX(-100%); transition: 0.3s; z-index: 100; padding: 25px; display:flex; flex-direction:column; box-shadow: 4px 0 25px rgba(0,0,0,0.3); }
        .sidebar.active { transform: translateX(0); }
        .nav-item { padding: 16px; color: #a8b2d1; font-weight: 500; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 15px; }
        .nav-item.active { color: var(--gold); background: rgba(197, 160, 89, 0.15); border-left: 4px solid var(--gold); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 90; display: none; backdrop-filter: blur(4px); }
        .overlay.active { display: block; }

        .main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        
        /* DATE FILTERS */
        .filter-bar { display: flex; background: white; padding: 5px; border-radius: 12px; margin-bottom: 15px; gap: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .filter-tab { flex: 1; text-align: center; padding: 8px 0; font-size: 11px; font-weight: bold; color: #888; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .filter-tab.active { background: var(--navy); color: var(--gold); }

        /* CARDS */
        .card { background: var(--white); border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.01); }
        .card-title { font-size: 16px; font-weight: 800; color: var(--navy); margin: 0; }
        
        /* KPI GRID */
        .kpi-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border-left: 4px solid var(--navy); position: relative; overflow: hidden; }
        .kpi-label { font-size: 11px; text-transform: uppercase; color: #888; font-weight: 700; letter-spacing: 0.5px; }
        .kpi-value { font-size: 20px; font-weight: 800; color: var(--text); margin-top: 5px; }

        /* CHARTS */
        .chart-compare { display: flex; height: 180px; align-items: flex-end; justify-content: center; gap: 40px; padding-top: 30px; position: relative; }
        .bar-group { display: flex; flex-direction: column; align-items: center; width: 60px; height: 100%; justify-content: flex-end; position: relative; z-index: 2; }
        .bar-visual { width: 50px; border-radius: 8px 8px 0 0; transition: height 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); min-height: 4px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .bar-label { font-size: 12px; color: #555; margin-top: 10px; font-weight: 600; }
        .bar-floating-val { position: absolute; top: -25px; font-size: 12px; font-weight: 800; color: var(--navy); background: white; padding: 2px 6px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chart-line-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between; z-index: 1; pointer-events: none; opacity: 0.3; }
        .chart-line { width: 100%; height: 1px; border-top: 1px dashed #ddd; }

        .donut-wrapper { display: flex; align-items: center; gap: 20px; }
        .donut-chart { width: 120px; height: 120px; border-radius: 50%; position: relative; flex-shrink: 0; }
        .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 70%; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: var(--navy); box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
        .legend-list { flex: 1; font-size: 12px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; justify-content: space-between; }
        .legend-dot { width: 10px; height: 10px; border-radius: 3px; margin-right: 8px; }

        .trend-chart { display: flex; height: 100px; align-items: flex-end; justify-content: space-between; gap: 4px; padding-top: 20px; }
        .trend-bar { flex: 1; border-radius: 4px; transition: 0.5s; position: relative; min-height: 2px; }
        .trend-label { font-size: 10px; text-align: center; color: #999; margin-top: 4px; }
        .trend-val { font-size: 9px; position: absolute; top: -15px; width: 100%; text-align: center; color: #555; font-weight: bold; }

        .hor-bar-item { margin-bottom: 12px; }
        .hor-bar-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; font-weight: 600; color: #444; }
        .hor-bar-bg { background: #f0f0f0; height: 10px; border-radius: 5px; overflow: hidden; }
        .hor-bar-fill { height: 100%; background: var(--navy); border-radius: 5px; width: 0; transition: width 1s; }

        .health-card { background: linear-gradient(135deg, var(--navy) 0%, #1a3a5e 100%); color: white; text-align: center; }
        .health-score { font-size: 36px; font-weight: 900; color: var(--gold); margin: 10px 0; }
        
        .acc-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 5px; scroll-behavior: smooth; }
        .acc-mini-card { min-width: 150px; background: white; padding: 15px; border-radius: 16px; flex-shrink: 0; border: 1px solid #eee; position: relative; }
        .acc-name { font-size: 12px; color: #888; text-transform: uppercase; font-weight: 700; }
        .acc-bal { font-size: 18px; font-weight: 800; color: var(--navy); margin-top: 5px; }

        .acc-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .acc-actions { display: flex; gap: 15px; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; justify-content: flex-end; }
        .acc-action-btn { font-size: 12px; color: #666; cursor: pointer; display: flex; align-items: center; gap: 5px; background: #f9f9f9; padding: 5px 10px; border-radius: 8px; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: #fff; width: 92%; max-width: 420px; padding: 25px; border-radius: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .form-control { width: 100%; padding: 14px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 16px; background: #fafafa; transition: 0.2s; margin-bottom: 15px; }
        .form-control:focus { border-color: var(--navy); background: #fff; box-shadow: 0 0 0 3px rgba(10, 25, 47, 0.1); }
        .btn { padding: 16px; border-radius: 14px; border: none; font-weight: 800; width: 100%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn-primary { background: var(--navy); color: white; box-shadow: 0 4px 15px rgba(10, 25, 47, 0.3); }

        .tx-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f5f5f5; }
        .icon-btn { cursor:pointer; font-size:18px; padding:8px; border-radius:8px; transition: background 0.2s; }
        .icon-del { color: var(--danger); }
        .tag-badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 10px; color: #666; margin-left: 5px; }
        
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 15px; }
        .cal-day { height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 12px; background: #f8f9fa; color: #666; font-weight: 600; }
        .cal-day.has-event { background: #e3f2fd; color: var(--navy); border: 1px solid #bbdefb; }
        .cal-day.paid { background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        
        .budget-row { margin-bottom: 15px; }
        .budget-info { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; font-weight: 600; color: #444; }
        .prog-container { background: #eee; height: 8px; border-radius: 4px; overflow: hidden; }
        .prog-bar { height: 100%; background: var(--success); transition: 0.5s; }
        .prog-bar.warn { background: var(--warning); }
        .prog-bar.danger { background: var(--danger); }
    </style>
</head>
<body>

    <div id="lock-screen">
        <img src="icon.jpeg" class="lock-logo" alt="Scala">
        <h2 style="margin:0; font-weight:900; color:var(--gold)">SavIA</h2>
        <p id="lock-msg" style="margin-bottom:30px; opacity:0.7">Ingrese su PIN</p>
        <div class="pin-dots">
            <div class="pin-dot" id="d1"></div>
            <div class="pin-dot" id="d2"></div>
            <div class="pin-dot" id="d3"></div>
            <div class="pin-dot" id="d4"></div>
        </div>
        <div class="numpad">
            <div class="num-btn" onclick="PIN.press(1)">1</div>
            <div class="num-btn" onclick="PIN.press(2)">2</div>
            <div class="num-btn" onclick="PIN.press(3)">3</div>
            <div class="num-btn" onclick="PIN.press(4)">4</div>
            <div class="num-btn" onclick="PIN.press(5)">5</div>
            <div class="num-btn" onclick="PIN.press(6)">6</div>
            <div class="num-btn" onclick="PIN.press(7)">7</div>
            <div class="num-btn" onclick="PIN.press(8)">8</div>
            <div class="num-btn" onclick="PIN.press(9)">9</div>
            <div class="num-btn" onclick="PIN.clear()">C</div>
            <div class="num-btn" onclick="PIN.press(0)">0</div>
            <div class="num-btn" onclick="PIN.back()">‚¨Ö</div>
        </div>
    </div>

    <div class="overlay" onclick="UI.toggleMenu()"></div>
    
    <nav class="sidebar" id="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px">
            <div class="app-title" style="color:var(--gold); font-size:22px">SavIA</div>
            <div onclick="UI.toggleMenu()" style="color:white; font-size:24px; cursor:pointer; padding:5px">‚úï</div>
        </div>
        <div class="nav-item active" onclick="UI.nav('dashboard')">üìä Dashboard</div>
        <div class="nav-item" onclick="UI.nav('budgets')">‚öñÔ∏è Presupuestos</div>
        <div class="nav-item" onclick="UI.nav('accounts')">üí≥ Cuentas</div>
        <div class="nav-item" onclick="UI.nav('transactions')">üìù Movimientos</div>
        <div class="nav-item" onclick="UI.nav('autopilot')">üìÖ Calendario</div>
        <div class="nav-item" onclick="UI.nav('tools')">üõ†Ô∏è Herramientas</div>
    </nav>

    <header class="topbar">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="menu-btn" onclick="UI.toggleMenu()">‚ò∞</div>
            <div class="app-title">SavIA</div>
        </div>
        <button class="add-btn" onclick="UI.openModal()">+ Ingresar Movimiento</button>
    </header>

    <main class="main" id="main-container">
        </main>

    <div id="modal-tx" class="modal">
        <div class="modal-box">
            <h3 id="modal-title" style="margin-top:0; color:var(--navy); font-size:22px; margin-bottom:20px">Nuevo Movimiento</h3>
            
            <div style="display:flex; gap:8px; margin-bottom:20px; background:#f5f5f5; padding:4px; border-radius:12px">
                <button class="btn" onclick="UI.setTxType('Gasto')" id="btn-type-gasto" style="flex:1; padding:10px; font-size:13px; background:white; color:var(--text); box-shadow:0 2px 5px rgba(0,0,0,0.05)">Gasto</button>
                <button class="btn" onclick="UI.setTxType('Ingreso')" id="btn-type-ingreso" style="flex:1; padding:10px; font-size:13px; background:transparent; color:#888">Ingreso</button>
                <button class="btn" onclick="UI.setTxType('Transferencia')" id="btn-type-transf" style="flex:1; padding:10px; font-size:13px; background:transparent; color:#888">Transf.</button>
            </div>

            <label style="font-size:12px; font-weight:bold; color:#888; margin-left:5px">MONTO</label>
            <input type="number" id="inp-amt" class="form-control" placeholder="$0" style="font-size:28px; font-weight:900; color:var(--navy); padding:10px;">

            <div id="group-cat">
                <label style="font-size:12px; font-weight:bold; color:#888; margin-left:5px">CATEGOR√çA</label>
                <div style="display:flex; gap:8px; margin-bottom:15px">
                    <select id="inp-cat" class="form-control" style="margin-bottom:0"></select>
                    <button onclick="APP.addCat()" style="width:50px; border:1px solid #e0e0e0; background:#f0f0f0; border-radius:12px; font-size:20px; color:var(--navy)">+</button>
                </div>
            </div>

            <div id="group-acc-source">
                <label style="font-size:12px; font-weight:bold; color:#888; margin-left:5px">CUENTA ORIGEN</label>
                <select id="inp-acc" class="form-control"></select>
            </div>
            
            <div id="group-acc-dest" style="display:none">
                <label style="font-size:12px; font-weight:bold; color:#888; margin-left:5px">CUENTA DESTINO</label>
                <select id="inp-acc-dest" class="form-control"></select>
            </div>

            <div style="display:flex; gap:15px">
                <div style="flex:1">
                    <label style="font-size:12px; font-weight:bold; color:#888; margin-left:5px">FECHA</label>
                    <input type="date" id="inp-date" class="form-control">
                </div>
                <div style="flex:1">
                    <label style="font-size:12px; font-weight:bold; color:#888; margin-left:5px">TAG</label>
                    <input type="text" id="inp-tag" class="form-control" placeholder="#Viaje">
                </div>
            </div>

            <input type="text" id="inp-note" class="form-control" placeholder="Nota opcional..." style="font-style:italic">
            
            <div style="display:flex; gap:15px; margin-top:10px">
                <button class="btn btn-primary" onclick="APP.saveTx()">Guardar</button>
                <button class="btn" style="background:#f0f0f0; color:#555" onclick="UI.closeModal()">Cancelar</button>
            </div>
        </div>
    </div>

<script>
    /** SAVIA ENGINE V10.2 - FINAL STABLE **/
    const UTILS = {
        fmt: (n) => "$" + parseInt(n).toLocaleString('es-CL'),
        id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
        date: () => new Date().toISOString().split('T')[0]
    };

    const DB = {
        data: { tx: [], acc: [], budgets: {}, goals: [], fix: [], cats: {} },
        init: function() {
            const raw = localStorage.getItem('savia_db_v5');
            if(raw) this.data = JSON.parse(raw);
            else this.migrate();
            
            if(!this.data.acc.length) this.data.acc = [{id:'acc_def', name:'Efectivo', type:'Efectivo', bal:0}];
            if(!this.data.cats.Personal) this.data.cats = { 
                Personal: { Gasto: ['Alimentaci√≥n','Transporte','Hogar','Salud','Ocio'], Ingreso: ['Sueldo','Extra'] } 
            };
        },
        save: function() { localStorage.setItem('savia_db_v5', JSON.stringify(this.data)); },
        migrate: function() {
            const oldTx = JSON.parse(localStorage.getItem('scala_uc_tx') || '[]');
            this.data.acc = [{id:'def', name:'Cuenta Principal', type:'Efectivo', bal:0}];
            this.data.tx = oldTx.map(t => ({...t, accId: 'def', tags: []}));
            this.save();
        }
    };

    const PIN = {
        val: "",
        stored: localStorage.getItem('savia_pin'),
        press: function(n) {
            if(this.val.length < 4) {
                this.val += n;
                this.updateUI();
                if(this.val.length === 4) this.check();
            }
        },
        back: function() { this.val = this.val.slice(0, -1); this.updateUI(); },
        clear: function() { this.val = ""; this.updateUI(); },
        updateUI: function() {
            for(let i=1; i<=4; i++) {
                document.getElementById('d'+i).classList.toggle('filled', i <= this.val.length);
            }
        },
        check: function() {
            if(!this.stored) {
                if(confirm(`¬øConfirmar PIN: ${this.val}?`)) {
                    localStorage.setItem('savia_pin', this.val);
                    this.stored = this.val;
                    alert("PIN Guardado. √ösalo para entrar.");
                    this.unlock();
                } else {
                    this.clear();
                }
            } else {
                if(this.val === this.stored) {
                    this.unlock();
                } else {
                    navigator.vibrate(200);
                    // ANIMACION DE TEMBLOR
                    const dots = document.querySelector('.pin-dots');
                    dots.classList.add('shake');
                    setTimeout(() => dots.classList.remove('shake'), 300);
                    
                    document.getElementById('lock-msg').innerText = "PIN Incorrecto";
                    document.getElementById('lock-msg').style.color = "var(--danger)";
                    setTimeout(() => {
                        this.clear();
                        document.getElementById('lock-msg').innerText = "Ingrese su PIN";
                        document.getElementById('lock-msg').style.color = "white";
                    }, 1000);
                }
            }
        },
        unlock: function() {
            document.getElementById('lock-screen').style.opacity = '0';
            setTimeout(() => document.getElementById('lock-screen').style.display = 'none', 300);
            APP.run();
        }
    };

    const APP = {
        currTxType: 'Gasto',
        editId: null,
        calDate: new Date(),
        filterRange: 'month', 

        init: function() {
            if(!localStorage.getItem('savia_pin')) {
                document.getElementById('lock-msg').innerText = "Crea un PIN de 4 d√≠gitos";
            }
        },

        run: function() {
            DB.init();
            UI.nav('dashboard');
        },
        
        getBalance: (accId) => {
            const acc = DB.data.acc.find(a => a.id === accId);
            if(!acc) return 0;
            let bal = parseFloat(acc.bal || 0);
            DB.data.tx.forEach(t => {
                if(t.accId === accId) {
                    if(t.type === 'Ingreso') bal += t.amt;
                    if(t.type === 'Gasto') bal -= t.amt;
                    if(t.type === 'Transferencia') bal -= t.amt;
                }
                if(t.destId === accId && t.type === 'Transferencia') bal += t.amt;
            });
            return bal;
        },

        getHistory: () => {
            const res = [];
            for(let i=5; i>=0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const mStr = d.toISOString().slice(0,7);
                const mName = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"][d.getMonth()];
                const mTx = DB.data.tx.filter(t => t.date.startsWith(mStr));
                const inc = mTx.filter(t => t.type === 'Ingreso').reduce((s,t) => s+t.amt, 0);
                const exp = mTx.filter(t => t.type === 'Gasto').reduce((s,t) => s+t.amt, 0);
                res.push({ month: mName, inc, exp });
            }
            return res;
        },

        getBudgetStatus: (cat) => {
            const limit = DB.data.budgets[cat] || 0;
            if(limit === 0) return null;
            const month = UTILS.date().slice(0,7);
            const spent = DB.data.tx.filter(t => t.cat === cat && t.type === 'Gasto' && t.date.startsWith(month)).reduce((s, t) => s + t.amt, 0);
            return { limit, spent, pct: (spent/limit)*100, remain: limit - spent };
        },
        
        getFilteredTx: function() {
            const now = new Date();
            let filterPrefix = '';
            if(this.filterRange === 'month') {
                filterPrefix = now.toISOString().slice(0,7);
            } else if(this.filterRange === 'prev') {
                now.setMonth(now.getMonth()-1);
                filterPrefix = now.toISOString().slice(0,7);
            } else if(this.filterRange === 'year') {
                filterPrefix = now.getFullYear().toString();
            } else {
                return DB.data.tx; 
            }
            return DB.data.tx.filter(t => t.date.startsWith(filterPrefix));
        },

        setFilter: function(range) {
            this.filterRange = range;
            UI.refreshCurrent();
        },

        addCat: function() {
            const n = prompt("Nombre de Nueva Categor√≠a (" + APP.currTxType + "):");
            if(n && APP.currTxType !== 'Transferencia') {
                if(!DB.data.cats.Personal[APP.currTxType].includes(n)) {
                    DB.data.cats.Personal[APP.currTxType].push(n); 
                    DB.save(); 
                }
                UI.renderCatOpts(); 
            }
        },

        delCat: function(catName) {
            if(confirm(`¬øBorrar "${catName}"?`)) {
                DB.data.cats.Personal.Gasto = DB.data.cats.Personal.Gasto.filter(c => c !== catName);
                if(DB.data.budgets[catName]) delete DB.data.budgets[catName];
                DB.save();
                UI.renderBudgets(document.getElementById('main-container'));
            }
        },

        saveTx: function() {
            const amt = parseFloat(document.getElementById('inp-amt').value);
            const desc = document.getElementById('inp-note').value;
            const date = document.getElementById('inp-date').value;
            const cat = document.getElementById('inp-cat').value;
            const accId = document.getElementById('inp-acc').value;
            const tag = document.getElementById('inp-tag').value;
            
            if(!amt || !date) return alert("Falta monto o fecha");

            const txObj = {
                id: APP.editId || UTILS.id(),
                type: APP.currTxType,
                amt, date, cat, note: desc, accId, tags: tag ? [tag] : []
            };

            if(APP.currTxType === 'Transferencia') {
                txObj.destId = document.getElementById('inp-acc-dest').value;
                txObj.cat = 'Transferencia';
                if(txObj.accId === txObj.destId) return alert("Cuentas iguales");
            }

            if(APP.editId) {
                const idx = DB.data.tx.findIndex(t => t.id === APP.editId);
                DB.data.tx[idx] = txObj;
            } else {
                DB.data.tx.push(txObj);
            }

            DB.save();
            UI.closeModal();
            UI.refreshCurrent();
        },
        
        delTx: (id) => { if(confirm("¬øEliminar?")) { DB.data.tx = DB.data.tx.filter(t=>t.id!==id); DB.save(); UI.refreshCurrent(); } },
        
        addAccount: function() {
            const n = prompt("Nombre Cuenta:");
            const t = prompt("Tipo:");
            const b = prompt("Saldo Inicial:", "0");
            if(n) { DB.data.acc.push({id: UTILS.id(), name: n, type: t || 'Banco', bal: parseFloat(b)}); DB.save(); UI.nav('accounts'); }
        },
        
        editAccount: function(id) {
            const acc = DB.data.acc.find(a => a.id === id);
            const newName = prompt("Editar Nombre:", acc.name);
            const newType = prompt("Editar Tipo:", acc.type);
            const newBal = prompt("Corregir Saldo Inicial:", acc.bal);
            if(newName) {
                acc.name = newName;
                if(newType) acc.type = newType;
                if(newBal !== null) acc.bal = parseFloat(newBal);
                DB.save();
                UI.refreshCurrent();
            }
        },

        delAccount: function(id) {
            if(confirm("¬øBorrar esta cuenta?")) {
                DB.data.acc = DB.data.acc.filter(a => a.id !== id);
                DB.save();
                UI.refreshCurrent();
            }
        },
        
        setBudget: function(cat) {
            const curr = DB.data.budgets[cat] || 0;
            const lim = prompt(`L√≠mite para ${cat} (0 para borrar):`, curr);
            if(lim !== null) {
                const val = parseFloat(lim);
                if(val === 0) delete DB.data.budgets[cat]; else DB.data.budgets[cat] = val;
                DB.save(); UI.nav('budgets');
            }
        },

        changeMonth: (delta) => { APP.calDate.setMonth(APP.calDate.getMonth() + delta); UI.refreshCurrent(); }
    };

    const UI = {
        currView: 'dashboard',
        
        toggleMenu: () => {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        },

        nav: (view) => {
            UI.currView = view;
            UI.toggleMenu();
            const main = document.getElementById('main-container');
            main.innerHTML = ''; 
            
            if(view === 'dashboard') UI.renderDashboard(main);
            if(view === 'transactions') UI.renderTransactions(main);
            if(view === 'accounts') UI.renderAccounts(main);
            if(view === 'budgets') UI.renderBudgets(main);
            if(view === 'tools') UI.renderTools(main);
            if(view === 'autopilot') UI.renderAutopilot(main);
        },

        refreshCurrent: () => UI.nav(UI.currView),

        renderDashboard: (el) => {
            const txList = APP.getFilteredTx();
            
            let inc = 0, exp = 0;
            const catSum = {};
            txList.forEach(t => {
                if(t.type === 'Ingreso') inc += t.amt;
                if(t.type === 'Gasto') { exp += t.amt; catSum[t.cat] = (catSum[t.cat] || 0) + t.amt; }
            });

            const maxVal = Math.max(inc, exp, 1); 
            const hInc = (inc / maxVal * 100) + '%'; 
            const hExp = (exp / maxVal * 100) + '%';

            const sortedCats = Object.keys(catSum).sort((a,b) => catSum[b] - catSum[a]);
            const colors = ['#0a192f', '#c5a059', '#27ae60', '#c0392b', '#8e44ad'];
            let deg = 0, gradient = [], legend = '';
            
            if(exp > 0) {
                sortedCats.slice(0,5).forEach((c, i) => {
                    const pct = catSum[c]/exp; 
                    const end = deg + (pct*360);
                    const col = colors[i%colors.length];
                    gradient.push(`${col} ${deg}deg ${end}deg`); deg = end;
                    legend += `<div class="legend-item"><div style="display:flex;align-items:center"><div class="legend-dot" style="background:${col}"></div><span>${c}</span></div><b>${Math.round(pct*100)}%</b></div>`;
                });
            } else {
                gradient = ['#eee 0deg 360deg'];
                legend = '<small style="color:#999">Sin datos</small>';
            }

            const history = APP.getHistory();
            const maxHist = Math.max(...history.map(h=>Math.max(h.inc, h.exp)), 1);
            let trendHtml = '';
            history.forEach(h => {
                const hH = (h.exp / maxHist * 80) + '%';
                trendHtml += `<div class="trend-bar" style="background:${h.exp>h.inc ? 'var(--danger)':'var(--navy)'}; height:${hH}"><div class="trend-val">$</div><div class="trend-label">${h.month}</div></div>`;
            });

            let topHtml = '';
            sortedCats.slice(0,3).forEach(c => {
                 const w = (catSum[c] / exp * 100) + '%';
                 topHtml += `<div class="hor-bar-item"><div class="hor-bar-header"><span>${c}</span><span>${UTILS.fmt(catSum[c])}</span></div><div class="hor-bar-bg"><div class="hor-bar-fill" style="width:${w}"></div></div></div>`;
            });

            const saveRate = inc > 0 ? ((inc - exp) / inc * 100) : 0;
            const healthColor = saveRate > 20 ? 'var(--success)' : (saveRate > 0 ? 'var(--warning)' : 'var(--danger)');

            let accHtml = '';
            DB.data.acc.forEach(a => {
                accHtml += `<div class="acc-mini-card"><div class="acc-name">${a.name}</div><div class="acc-bal">${UTILS.fmt(APP.getBalance(a.id))}</div></div>`;
            });

            el.innerHTML = `
                <div class="filter-bar">
                    <div class="filter-tab ${APP.filterRange==='month'?'active':''}" onclick="APP.setFilter('month')">Mes</div>
                    <div class="filter-tab ${APP.filterRange==='prev'?'active':''}" onclick="APP.setFilter('prev')">Mes Ant.</div>
                    <div class="filter-tab ${APP.filterRange==='year'?'active':''}" onclick="APP.setFilter('year')">A√±o</div>
                    <div class="filter-tab ${APP.filterRange==='all'?'active':''}" onclick="APP.setFilter('all')">Todo</div>
                </div>

                <div class="acc-scroll">${accHtml} <div class="acc-mini-card" onclick="APP.addAccount()" style="background:#eee; display:flex; align-items:center; justify-content:center; font-size:24px">+</div></div>
                
                <div class="card health-card">
                    <div style="font-size:12px; opacity:0.8; text-transform:uppercase">Salud Financiera (Ahorro)</div>
                    <div class="health-score" style="color:${healthColor}">${Math.round(saveRate)}%</div>
                    <div style="font-size:11px">Meta sugerida: 20%</div>
                </div>

                <div class="kpi-row">
                    <div class="kpi-card" style="border-color:var(--success)"><div class="kpi-label">Ingresos</div><div class="kpi-value">${UTILS.fmt(inc)}</div></div>
                    <div class="kpi-card" style="border-color:var(--danger)"><div class="kpi-label">Gastos</div><div class="kpi-value">${UTILS.fmt(exp)}</div></div>
                </div>

                <div class="card">
                    <h3 class="card-title">Flujo de Caja</h3>
                    <div class="chart-compare">
                        <div class="chart-line-bg"><div class="chart-line"></div><div class="chart-line"></div><div class="chart-line"></div></div>
                        <div class="bar-group"><div class="bar-floating-val">${UTILS.fmt(inc)}</div><div class="bar-visual" style="background:var(--success); height:${hInc}"></div><div class="bar-label">Ingresos</div></div>
                        <div class="bar-group"><div class="bar-floating-val">${UTILS.fmt(exp)}</div><div class="bar-visual" style="background:var(--danger); height:${hExp}"></div><div class="bar-label">Gastos</div></div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Distribuci√≥n</h3>
                    <div class="donut-wrapper">
                        <div class="donut-chart" style="background:conic-gradient(${gradient.join(',')})"><div class="donut-center">GASTOS</div></div>
                        <div class="legend-list">${legend}</div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Top Fugas üí∏</h3>
                    <div style="margin-top:15px">${topHtml || '<small>Sin gastos</small>'}</div>
                </div>

                <div class="card">
                    <h3 class="card-title">Tendencia (6 Meses)</h3>
                    <div class="trend-chart">${trendHtml}</div>
                </div>
            `;
        },

        renderTransactions: (el) => {
            el.innerHTML = `<div class="card"><input type="text" id="search-tx" class="form-control" placeholder="üîç Buscar..." onkeyup="UI.renderTxList(this.value)" style="margin-bottom:0"></div><div class="card" id="tx-list"></div>`;
            UI.renderTxList();
        },

        renderTxList: (filter = '') => {
            const listEl = document.getElementById('tx-list');
            listEl.innerHTML = '';
            let data = DB.data.tx.sort((a,b) => new Date(b.date) - new Date(a.date));
            if(filter) {
                const f = filter.toLowerCase();
                data = data.filter(t => (t.note+t.cat+t.tags.join('')).toLowerCase().includes(f));
            }
            data.slice(0, 50).forEach(t => {
                const accName = DB.data.acc.find(a=>a.id===t.accId)?.name || '???';
                let icon = 'üí∏'; if(t.type==='Ingreso') icon = 'üí∞'; if(t.type==='Transferencia') icon = 'üîÑ';
                
                listEl.innerHTML += `
                    <div class="tx-row">
                        <div style="flex:1" onclick="UI.editTx('${t.id}')">
                            <div style="display:flex; align-items:center; gap:10px">
                                <div style="background:#f4f7f6; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center">${icon}</div>
                                <div>
                                    <div style="font-weight:bold; font-size:14px">${t.cat} ${t.tags.map(tag=>`<span class="tag-badge">${tag}</span>`).join('')}</div>
                                    <div style="font-size:11px; color:#888">${t.date} ‚Ä¢ ${accName}</div>
                                    ${t.note ? `<div style="font-size:11px; color:#666; font-style:italic">${t.note}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-weight:bold; color:${t.type==='Ingreso'?'var(--success)':'var(--text)'}">${t.type==='Gasto'?'-':''} ${UTILS.fmt(t.amt)}</div>
                            <div style="margin-top:5px">
                                <span class="icon-btn" onclick="UI.editTx('${t.id}')">‚úèÔ∏è</span>
                                <span class="icon-btn icon-del" onclick="APP.delTx('${t.id}')">üóëÔ∏è</span>
                            </div>
                        </div>
                    </div>`;
            });
        },

        renderBudgets: (el) => {
            let html = '<div class="card"><button class="btn btn-primary" style="margin-bottom:15px" onclick="APP.addCat()">+ Nueva Categor√≠a</button><h3>Presupuestos Mensuales</h3>';
            const allCats = DB.data.cats.Personal.Gasto; 
            allCats.forEach(cat => {
                const st = APP.getBudgetStatus(cat);
                const limit = DB.data.budgets[cat] || 0;
                html += `
                    <div class="tx-row">
                        <div onclick="APP.setBudget('${cat}')" style="flex:1">
                            <b>${cat}</b><br>
                            <small>${limit > 0 ? 'L√≠mite: '+UTILS.fmt(limit) : 'Sin l√≠mite'}</small>
                        </div>
                        <div style="text-align:right; display:flex; gap:10px; align-items:center">
                            <span>${st ? UTILS.fmt(st.spent) : '$0'}</span>
                            <span class="icon-btn" onclick="APP.setBudget('${cat}')">‚úèÔ∏è</span>
                            <span class="icon-btn icon-del" onclick="APP.delCat('${cat}')">üóëÔ∏è</span>
                        </div>
                    </div>`;
            });
            html += '</div>';
            el.innerHTML = html;
        },
        
        renderAccounts: (el) => {
            el.innerHTML = `<button class="btn btn-primary" style="margin-bottom:15px" onclick="APP.addAccount()">+ Nueva Cuenta</button>`;
            DB.data.acc.forEach(a => {
                el.innerHTML += `
                    <div class="card">
                        <div class="acc-row">
                            <div>
                                <h3 style="margin:0; font-size:16px">${a.name}</h3>
                                <div style="font-size:12px; color:#888">${a.type}</div>
                            </div>
                            <div style="text-align:right">
                                <h2 style="color:var(--navy); margin:0">${UTILS.fmt(APP.getBalance(a.id))}</h2>
                            </div>
                        </div>
                        <div class="acc-actions">
                             <div class="acc-action-btn" onclick="APP.editAccount('${a.id}')">‚úèÔ∏è Editar</div>
                             <div class="acc-action-btn" onclick="APP.delAccount('${a.id}')" style="color:var(--danger)">üóëÔ∏è Borrar</div>
                        </div>
                    </div>`;
            });
        },

        renderAutopilot: (el) => {
            const y = APP.calDate.getFullYear(), m = APP.calDate.getMonth();
            const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
            const firstDay = new Date(y, m, 1).getDay() || 7;
            const daysInMonth = new Date(y, m+1, 0).getDate();
            const monthStr = APP.calDate.toISOString().slice(0,7);
            const monthTx = DB.data.tx.filter(t => t.date.startsWith(monthStr));
            
            let calHtml = `<div class="cal-grid">`;
            for(let i=1; i<firstDay; i++) calHtml += `<div></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const dayFixes = DB.data.fix.filter(f => parseInt(f.day) === d);
                let cls = 'cal-day';
                let isPaid = dayFixes.length > 0 && dayFixes.every(f => monthTx.some(t => t.cat === f.name));
                if(dayFixes.length > 0) cls += isPaid ? ' paid has-event' : ' has-event';
                calHtml += `<div class="${cls}">${d}</div>`;
            }
            calHtml += `</div>`;

            el.innerHTML = `
                <div class="card">
                    <div class="cal-header">
                        <button onclick="APP.changeMonth(-1)" class="btn" style="width:auto; padding:5px 15px; background:#f0f0f0; color:#333">‚ùÆ</button>
                        <b style="color:var(--navy); font-size:16px">${monthNames[m]} ${y}</b>
                        <button onclick="APP.changeMonth(1)" class="btn" style="width:auto; padding:5px 15px; background:#f0f0f0; color:#333">‚ùØ</button>
                    </div>
                    ${calHtml}
                </div>
                <div class="card">
                    <h3>Cuentas Fijas</h3>
                    <button class="btn btn-primary" onclick="APP.addFix()">+ Nueva Cuenta Fija</button>
                    <div id="fix-list" style="margin-top:15px"></div>
                </div>
            `;

            const list = document.getElementById('fix-list');
            DB.data.fix.forEach(f => {
                const isPaid = monthTx.some(t => t.cat === f.name);
                list.innerHTML += `<div class="tx-row"><div><b>${f.name}</b> (D√≠a ${f.day})<br><small>${UTILS.fmt(f.cost)}</small></div><div>${isPaid ? '<span style="color:green; font-weight:bold">‚úÖ Pagado</span>' : `<button class="btn-gold" style="padding:5px 10px; font-size:12px; border-radius:6px" onclick="APP.quickPay('${f.name}', ${f.cost})">Pagar</button>`}</div></div>`;
            });
        },

        renderTools: (el) => {
            el.innerHTML = `<div class="card"><h3>üì• Importar / Exportar</h3><button class="btn" style="background:var(--gold); color:var(--navy)" onclick="TOOLS.exportJSON()">Hacer Backup (JSON)</button><br><button class="btn" style="background:white; border:1px solid #ccc; color:#333" onclick="document.getElementById('file-import').click()">Restaurar Backup</button><input type="file" id="file-import" style="display:none" onchange="TOOLS.importJSON(this)"></div>`;
        },

        // --- MODALES & FORMS ---
        openModal: () => {
            APP.editId = null;
            document.getElementById('modal-title').innerText = "Nuevo Movimiento";
            document.getElementById('inp-amt').value = '';
            document.getElementById('inp-note').value = '';
            document.getElementById('inp-tag').value = '';
            document.getElementById('inp-date').value = UTILS.date();
            UI.renderAccOpts();
            UI.setTxType('Gasto');
            document.getElementById('modal-tx').style.display = 'flex';
        },
        
        closeModal: () => document.getElementById('modal-tx').style.display = 'none',

        editTx: (id) => {
            const t = DB.data.tx.find(x=>x.id===id);
            if(!t) return;
            UI.openModal();
            APP.editId = id;
            document.getElementById('modal-title').innerText = "Editar Movimiento";
            UI.setTxType(t.type);
            document.getElementById('inp-amt').value = t.amt;
            document.getElementById('inp-date').value = t.date;
            document.getElementById('inp-cat').value = t.cat;
            document.getElementById('inp-acc').value = t.accId;
            document.getElementById('inp-note').value = t.note;
            document.getElementById('inp-tag').value = t.tags ? t.tags.join(' ') : '';
        },

        setTxType: (type) => {
            APP.currTxType = type;
            
            // 1. Resetear todos
            ['gasto','ingreso','transf'].forEach(t => {
                const btn = document.getElementById('btn-type-'+t);
                btn.style.background = 'transparent';
                btn.style.color = '#888';
                btn.style.boxShadow = 'none';
            });

            // 2. Colorear el seleccionado (Fixed for "Ingreso")
            let id = 'btn-type-gasto';
            if(type === 'Ingreso') id = 'btn-type-ingreso';
            if(type === 'Transferencia') id = 'btn-type-transf';

            const activeBtn = document.getElementById(id);
            if(activeBtn) {
                activeBtn.style.background = 'var(--navy)';
                activeBtn.style.color = 'var(--gold)';
                activeBtn.style.boxShadow = '0 2px 5px rgba(0,0,0,0.05)';
            }

            if(type === 'Transferencia') {
                document.getElementById('group-cat').style.display = 'none';
                document.getElementById('group-acc-dest').style.display = 'block';
            } else {
                document.getElementById('group-cat').style.display = 'block';
                document.getElementById('group-acc-dest').style.display = 'none';
                UI.renderCatOpts();
            }
        },

        renderCatOpts: () => {
            const sel = document.getElementById('inp-cat');
            sel.innerHTML = '';
            const list = DB.data.cats.Personal[APP.currTxType] || [];
            list.forEach(c => sel.innerHTML += `<option>${c}</option>`);
        },

        renderAccOpts: () => {
            const fill = (id) => {
                const el = document.getElementById(id);
                el.innerHTML = '';
                DB.data.acc.forEach(a => el.innerHTML += `<option value="${a.id}">${a.name} ($${a.bal})</option>`);
            };
            fill('inp-acc');
            fill('inp-acc-dest');
        }
    };

    APP.addFix = function() {
        const n = prompt("Nombre Gasto Fijo:");
        const c = prompt("Monto Estimado:");
        const d = prompt("D√≠a de Pago (1-31):");
        if(n && c) { DB.data.fix.push({id:UTILS.id(), name:n, cost:c, day:d}); DB.save(); UI.refreshCurrent(); }
    };

    APP.quickPay = function(name, cost) {
        APP.currTxType = 'Gasto';
        APP.editId = null;
        UI.openModal();
        setTimeout(() => {
             if(!DB.data.cats.Personal.Gasto.includes(name)) {
                 DB.data.cats.Personal.Gasto.push(name);
                 UI.renderCatOpts();
             }
             document.getElementById('inp-cat').value = name;
             document.getElementById('inp-amt').value = cost;
             document.getElementById('inp-note').value = 'Pago Recurrente';
        }, 100);
    };

    const TOOLS = {
        exportJSON: () => {
            const str = JSON.stringify(DB.data);
            const blob = new Blob([str], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `savia_backup_${UTILS.date()}.json`;
            a.click();
        },
        importJSON: (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if(confirm("Esto reemplazar√° todos tus datos actuales. ¬øSeguro?")) {
                    DB.data = JSON.parse(e.target.result);
                    DB.save();
                    location.reload();
                }
            };
            reader.readAsText(file);
        }
    };

    APP.init();

</script>
</body>
</html>
