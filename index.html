<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a192f">
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <title>Savia App</title>
    <style>
        :root { --navy: #0a192f; --gold: #c5a059; --bg: #f0f2f5; --white: #fff; --text: #333; --danger: #c0392b; --success: #27ae60; }
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        /* HEADER & NAV */
        .topbar { background: var(--white); padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 20; height: 60px; }
        .menu-btn { font-size: 24px; color: var(--navy); cursor: pointer; padding: 5px; }
        .app-title { font-weight: 800; color: var(--navy); font-size: 18px; }
        .add-btn { background: var(--navy); color: var(--gold); border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 280px; background: var(--navy); transform: translateX(-100%); transition: 0.3s; z-index: 100; padding-top: 20px; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
        .sidebar.active { transform: translateX(0); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; display: none; }
        .overlay.active { display: block; }
        .nav-item { padding: 15px 25px; color: #a8b2d1; font-weight: 500; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .nav-item.active { color: var(--gold); background: rgba(197, 160, 89, 0.1); border-left: 4px solid var(--gold); }
        .close-menu { text-align: right; padding: 0 20px; color: #fff; font-size: 24px; margin-bottom: 20px; cursor: pointer; }
        
        /* CONTENIDO */
        .main { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; padding-bottom: 80px; }
        .card { background: var(--white); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        /* KPIS */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-box { background: var(--white); padding: 12px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-bottom: 3px solid #ccc; }
        .kpi-label { font-size: 10px; text-transform: uppercase; color: #888; font-weight: 700; }
        .kpi-value { font-size: 18px; font-weight: 800; color: var(--navy); margin-top: 5px; }
        
        /* BOTONES */
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; }
        .btn-gold { background: var(--gold); color: var(--navy); }
        .btn-primary { background: var(--navy); color: white; }
        
        /* TABLAS Y CALENDARIO */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        td { padding: 10px 5px; border-bottom: 1px solid #eee; }
        th { text-align: left; padding: 10px 5px; color: #888; font-size: 11px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .cal-day { height: 40px; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 12px; position: relative; }
        .has-event { background: #e3f2fd; color: var(--navy); font-weight: bold; border-color: var(--navy); }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: #fff; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .form-control { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: #fafafa; }
        .scope-select { border: none; background: #f0f2f5; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; color: var(--navy); }
    </style>
</head>
<body>
    <div class="overlay" onclick="toggleMenu()"></div>
    <div class="sidebar" id="sidebar">
        <div class="close-menu" onclick="toggleMenu()">‚úï</div>
        <div class="nav-item active" onclick="nav('dashboard')">üìä Dashboard</div>
        <div class="nav-item" onclick="nav('transactions')">üìù Movimientos</div>
        <div class="nav-item" onclick="nav('autopilot')">üìÖ Calendario</div>
        <div class="nav-item" onclick="nav('goals')">üéØ Metas</div>
        <div style="padding: 20px; font-size: 12px; color: #666; text-align: center; margin-top: auto;">ScalaSpA v3.0 Pro</div>
    </div>
    <div class="topbar">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
            <div class="app-title">Savia</div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select class="scope-select" id="scope-select" onchange="APP.refresh()">
                <option value="Personal">Personal</option>
                <option value="Negocio">Negocio</option>
            </select>
            <button class="add-btn" onclick="APP.openModal()">+</button>
        </div>
    </div>
    <div class="main">
        <div id="view-dashboard">
            <div id="alerts-area"></div>
            <div class="kpi-grid">
                <div class="kpi-box" style="border-bottom-color: var(--navy)"><div class="kpi-label">Balance</div><div class="kpi-value" id="kpi-bal">$0</div></div>
                <div class="kpi-box" style="border-bottom-color: #b7950b"><div class="kpi-label">Proyecci√≥n</div><div class="kpi-value" id="kpi-proj" style="color:#b7950b">$0</div></div>
                <div class="kpi-box" style="border-bottom-color: var(--success)"><div class="kpi-label">Ingresos</div><div class="kpi-value" id="kpi-inc" style="color:var(--success)">$0</div></div>
                <div class="kpi-box" style="border-bottom-color: var(--danger)"><div class="kpi-label">Gastos</div><div class="kpi-value" id="kpi-exp" style="color:var(--danger)">$0</div></div>
            </div>
            
            <div class="card">
                <h3 style="margin-top:0; font-size:16px;">Flujo de Caja</h3>
                <div style="display:flex; height:120px; align-items:flex-end; gap:20px; padding-bottom:10px;">
                    <div style="flex:1; text-align:center;"><div id="bar-inc" style="background:var(--success); height:1px; min-height:1px; border-radius:4px 4px 0 0; transition:0.5s"></div><small>Ing</small></div>
                    <div style="flex:1; text-align:center;"><div id="bar-exp" style="background:var(--danger); height:1px; min-height:1px; border-radius:4px 4px 0 0; transition:0.5s"></div><small>Gas</small></div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0; font-size:16px;">Distribuci√≥n de Gastos</h3>
                <div id="chart-donut" style="margin-top:10px;"></div>
            </div>

            <button class="btn btn-gold" onclick="APP.exportExcelFixed()">üíæ Descargar Excel</button>
        </div>
        
        <div id="view-transactions" style="display:none">
            <div class="card"><h3 style="margin-top:0">Historial</h3><table id="tx-table"><thead><tr><th>Fecha</th><th>Cat</th><th>$</th><th></th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="view-autopilot" style="display:none">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <button onclick="APP.changeMonth(-1)" style="background:none; border:none; font-size:18px;">‚ùÆ</button><b id="cal-title" style="color:var(--navy)">Mes</b><button onclick="APP.changeMonth(1)" style="background:none; border:none; font-size:18px;">‚ùØ</button>
                </div>
                <div class="cal-grid" id="cal-grid"></div>
                <button class="btn btn-primary" style="margin-top:15px;" onclick="APP.addFix()">+ Agregar Cuenta Fija</button>
            </div>
            <div class="card"><h3>Vencimientos</h3><table id="fix-table"><thead><tr><th>D√≠a</th><th>Cuenta</th><th>$</th><th></th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="view-goals" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h3>Metas</h3><button class="btn-primary" style="padding:5px 10px; border-radius:5px;" onclick="APP.addGoal()">+</button></div>
            <div id="goals-list" style="display:flex; flex-direction:column; gap:10px;"></div>
        </div>
    </div>
    
    <div id="modal" class="modal">
        <div class="modal-box">
            <h3 style="color:var(--navy); margin-top:0">Nuevo Registro</h3>
            <select id="inp-type" class="form-control" onchange="APP.updateCats()"><option>Gasto</option><option>Ingreso</option><option>Gasto Fijo</option></select>
            <div style="display:flex; gap:5px;"><select id="inp-cat" class="form-control" style="flex:1"></select><button onclick="APP.addCustomCat()" style="height:46px; width:40px; background:#eee; border:1px solid #ddd; border-radius:8px;">+</button></div>
            <input type="number" id="inp-amt" class="form-control" placeholder="Monto (Ej: 5000)">
            <input type="date" id="inp-date" class="form-control">
            <input type="text" id="inp-note" class="form-control" placeholder="Nota (Opcional)">
            <div style="display:flex; gap:10px;"><button class="btn btn-primary" onclick="APP.saveTx()">Guardar</button><button class="btn" style="background:#eee; color:#333" onclick="APP.closeModal()">Cancelar</button></div>
        </div>
    </div>
<script>
    const DEFAULT_CATS = { Personal: { Ingreso: ['Sueldo', 'Extra'], Gasto: ['Comida', 'Transporte', 'Salud', 'Ocio', 'Hogar'], 'Gasto Fijo': ['Arriendo', 'Luz', 'Internet'] }, Negocio: { Ingreso: ['Ventas', 'Servicios'], Gasto: ['Insumos', 'Publicidad', 'Log√≠stica'], 'Gasto Fijo': ['Sueldos', 'Impuestos', 'Arriendo'] } };
    function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.querySelector('.overlay').classList.toggle('active'); }
    function nav(id) { document.querySelectorAll('[id^="view-"]').forEach(d => d.style.display = 'none'); document.getElementById('view-'+id).style.display = 'block'; toggleMenu(); APP.refresh(); }
    
    window.APP = {
        data: { tx: [], fix: [], goals: [] }, cats: JSON.parse(JSON.stringify(DEFAULT_CATS)), scope: 'Personal', calDate: new Date(),
        init: function() {
            try {
                if(localStorage.getItem('scala_uc_tx')) this.data.tx = JSON.parse(localStorage.getItem('scala_uc_tx'));
                if(localStorage.getItem('scala_uc_fix')) this.data.fix = JSON.parse(localStorage.getItem('scala_uc_fix'));
                if(localStorage.getItem('scala_uc_goals')) this.data.goals = JSON.parse(localStorage.getItem('scala_uc_goals'));
                if(localStorage.getItem('scala_uc_cats')) this.cats = JSON.parse(localStorage.getItem('scala_uc_cats'));
                document.getElementById('inp-date').valueAsDate = new Date(); this.refresh();
            } catch(e) { console.log("Error cargando datos", e); }
        },
        save: function() { localStorage.setItem('scala_uc_tx', JSON.stringify(this.data.tx)); localStorage.setItem('scala_uc_fix', JSON.stringify(this.data.fix)); localStorage.setItem('scala_uc_goals', JSON.stringify(this.data.goals)); localStorage.setItem('scala_uc_cats', JSON.stringify(this.cats)); },
        refresh: function() {
            this.scope = document.getElementById('scope-select').value; const list = this.data.tx.filter(t => t.scope === this.scope); const now = new Date(); const curMonth = list.filter(t => t.date.startsWith(now.toISOString().slice(0,7)));
            let inc=0, exp=0; curMonth.forEach(t => t.type==='Ingreso' ? inc+=t.amt : exp+=t.amt);
            
            const total = list.reduce((acc, t) => acc + (t.type==='Ingreso'?t.amt:-t.amt), 0);
            document.getElementById('kpi-bal').innerText = "$"+total.toLocaleString(); document.getElementById('kpi-inc').innerText = "$"+inc.toLocaleString(); document.getElementById('kpi-exp').innerText = "$"+exp.toLocaleString();
            let pending = 0; this.data.fix.filter(f => f.scope === this.scope).forEach(f => { if(!curMonth.some(t => t.cat === f.name)) pending += parseFloat(f.cost); });
            document.getElementById('kpi-proj').innerText = "$"+(exp+pending).toLocaleString();
            
            // GRAFICO BARRAS (Fixed)
            const max = Math.max(inc, exp, 1); 
            document.getElementById('bar-inc').style.height = (inc/max*120)+'px'; 
            document.getElementById('bar-exp').style.height = (exp/max*120)+'px';
            
            this.renderDonut(curMonth);
            this.renderTx(list); this.renderCal(); this.renderGoals();
        },
        renderDonut: function(list) {
            const expList = list.filter(t => t.type !== 'Ingreso');
            if(expList.length === 0) { document.getElementById('chart-donut').innerHTML = '<p style="text-align:center;color:#999;font-size:12px">Sin gastos este mes</p>'; return; }
            const catSum = {}; let total = 0;
            expList.forEach(t => { catSum[t.cat] = (catSum[t.cat] || 0) + t.amt; total += t.amt; });
            const sorted = Object.keys(catSum).sort((a,b) => catSum[b] - catSum[a]).slice(0, 5);
            const colors = ['#0a192f', '#c5a059', '#27ae60', '#c0392b', '#8e44ad'];
            let deg = 0, gradient = [], legend = '';
            sorted.forEach((c, i) => {
                const pct = catSum[c]/total; const end = deg + (pct*360);
                const col = colors[i%colors.length];
                gradient.push(`${col} ${deg}deg ${end}deg`); deg = end;
                legend += `<div style="display:flex;align-items:center;font-size:11px;margin-bottom:4px"><div style="width:8px;height:8px;background:${col};margin-right:8px;border-radius:2px"></div><div style="flex:1">${c}</div><div>${Math.round(pct*100)}%</div></div>`;
            });
            document.getElementById('chart-donut').innerHTML = `<div style="display:flex;align-items:center;gap:15px;justify-content:center"><div style="width:90px;height:90px;border-radius:50%;background:conic-gradient(${gradient.join(',')});flex-shrink:0;border:8px solid #f8f9fa"></div><div style="flex:1">${legend}</div></div>`;
        },
        renderTx: function(list) {
            const tb = document.querySelector('#tx-table tbody'); tb.innerHTML = '';
            list.sort((a,b) => new Date(b.date)-new Date(a.date)).slice(0, 20).forEach(t => { const color = t.type==='Ingreso' ? 'green' : 'red'; tb.innerHTML += `<tr><td>${t.date.slice(5)}</td><td>${t.cat}<br><small style="color:#888">${t.note}</small></td><td style="color:${color}; font-weight:bold">$${t.amt.toLocaleString()}</td><td><span onclick="APP.delTx(${t.id})" style="color:red;font-weight:bold;padding:5px">√ó</span></td></tr>`; });
        },
        renderCal: function() {
            const y = this.calDate.getFullYear(), m = this.calDate.getMonth();
            const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"]; document.getElementById('cal-title').innerText = monthNames[m] + " " + y;
            const firstDay = new Date(y, m, 1).getDay() || 7; const daysInMonth = new Date(y, m+1, 0).getDate();
            const grid = document.getElementById('cal-grid'); grid.innerHTML = ''; for(let i=1; i<firstDay; i++) grid.innerHTML += `<div></div>`;
            const fixes = this.data.fix.filter(f => f.scope === this.scope); const curMonthTx = this.data.tx.filter(t => t.scope===this.scope && new Date(t.date).getMonth()===m && new Date(t.date).getFullYear()===y);
            for(let d=1; d<=daysInMonth; d++) {
                const dayFixes = fixes.filter(f => parseInt(f.day) === d); let cls = 'cal-day'; if(dayFixes.length > 0) cls += ' has-event'; const allPaid = dayFixes.every(f => curMonthTx.some(t => t.cat === f.name));
                if(dayFixes.length > 0 && allPaid) grid.innerHTML += `<div class="${cls}" style="background:#d4edda; border-color:green; color:green">${d}</div>`; else grid.innerHTML += `<div class="${cls}">${d}</div>`;
            }
            const tb = document.querySelector('#fix-table tbody'); tb.innerHTML = ''; fixes.sort((a,b)=>a.day-b.day).forEach(f => { const paid = curMonthTx.some(t => t.cat === f.name); tb.innerHTML += `<tr><td>${f.day}</td><td>${f.name}</td><td>$${parseInt(f.cost).toLocaleString()}</td><td>${paid?'‚úÖ':'‚è≥'} <span onclick="APP.delFix(${f.id})" style="color:red;margin-left:5px">√ó</span></td></tr>`; });
        },
        renderGoals: function() {
            const d = document.getElementById('goals-list'); d.innerHTML = ''; this.data.goals.forEach(g => { const pct = Math.min((g.curr/g.target)*100, 100); d.innerHTML += `<div class="card" style="margin-bottom:0"><div style="display:flex; justify-content:space-between"><b>${g.name}</b><span onclick="APP.delGoal(${g.id})" style="color:red">√ó</span></div><div>$${g.curr.toLocaleString()} / $${g.target.toLocaleString()}</div><div style="background:#eee;height:8px;border-radius:4px;margin:5px 0"><div style="background:var(--gold);width:${pct}%;height:100%"></div></div><button onclick="APP.fundGoal(${g.id})" style="width:100%;padding:5px;background:#eee;border:none">Agregar Fondos</button></div>`; });
        },
        openModal: function() { document.getElementById('modal').style.display = 'flex'; this.updateCats(); }, closeModal: function() { document.getElementById('modal').style.display = 'none'; },
        updateCats: function() { const t = document.getElementById('inp-type').value; const sel = document.getElementById('inp-cat'); sel.innerHTML = ''; let list = this.cats[this.scope][t]; if(t==='Gasto Fijo') list = [...list, ...this.data.fix.filter(f=>f.scope===this.scope).map(f=>f.name)]; [...new Set(list)].forEach(c => sel.innerHTML += `<option>${c}</option>`); },
        addCustomCat: function() { const t = document.getElementById('inp-type').value; const n = prompt("Nueva Categor√≠a:"); if(n) { this.cats[this.scope][t].push(n); this.save(); this.updateCats(); } },
        saveTx: function() { const amt = document.getElementById('inp-amt').value; const date = document.getElementById('inp-date').value; if(!amt || !date) return alert("Faltan datos"); this.data.tx.push({ id: Date.now(), scope: this.scope, amt: parseFloat(amt), date: date, type: document.getElementById('inp-type').value, cat: document.getElementById('inp-cat').value, note: document.getElementById('inp-note').value }); this.save(); this.closeModal(); this.refresh(); },
        delTx: function(id) { if(confirm("¬øBorrar?")) { this.data.tx = this.data.tx.filter(x=>x.id!==id); this.save(); this.refresh(); }},
        addFix: function() { const n = prompt("Nombre Gasto (Ej: Netflix)"); const c = prompt("Costo Mensual"); const d = prompt("D√≠a de Pago (1-31)"); if(n&&c&&d) { this.data.fix.push({id:Date.now(), scope:this.scope, name:n, cost:c, day:d}); this.save(); this.refresh(); } },
        delFix: function(id) { if(confirm("¬øBorrar Fijo?")) { this.data.fix = this.data.fix.filter(x=>x.id!==id); this.save(); this.refresh(); }},
        addGoal: function() { const n = prompt("Meta:"); const t = prompt("Monto:"); if(n&&t) { this.data.goals.push({id:Date.now(), name:n, target:t, curr:0}); this.save(); this.refresh(); } },
        delGoal: function(id) { if(confirm("¬øBorrar Meta?")) { this.data.goals = this.data.goals.filter(x=>x.id!==id); this.save(); this.refresh(); }},
        fundGoal: function(id) { const m = prompt("Monto a agregar:"); if(m) { this.data.goals.find(x=>x.id===id).curr += parseFloat(m); this.save(); this.refresh(); } },
        exportExcelFixed: function() { let csvContent = "data:text/csv;charset=utf-8,Fecha,Ambito,Tipo,Categoria,Monto,Nota\\n"; this.data.tx.forEach(t => { csvContent += `${t.date},${t.scope},${t.type},${t.cat},${t.amt},${t.note}\\n`; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "savia_data.csv"); document.body.appendChild(link); link.click(); }
    };
    window.onload = function() { APP.init(); };
</script>
</body>
</html>
